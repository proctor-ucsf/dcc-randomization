<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Generating Randomization Sequences | Francis I. Proctor Foundation   Guide to Randomization</title>
  <meta name="description" content="This is a short guide for best (essential!) practices for trial randomization." />
  <meta name="generator" content="bookdown 0.21.6 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Generating Randomization Sequences | Francis I. Proctor Foundation   Guide to Randomization" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a short guide for best (essential!) practices for trial randomization." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Generating Randomization Sequences | Francis I. Proctor Foundation   Guide to Randomization" />
  
  <meta name="twitter:description" content="This is a short guide for best (essential!) practices for trial randomization." />
  

<meta name="author" content="Contributors: Ben Arnold" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="directory.html"/>
<link rel="next" href="randomizationdiagnostics.html"/>
<script src="libs/header-attrs-2.7.3/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Guide to Randomization</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome!</a></li>
<li class="chapter" data-level="1" data-path="overview.html"><a href="overview.html"><i class="fa fa-check"></i><b>1</b> Overview and Introduction</a></li>
<li class="chapter" data-level="2" data-path="computing.html"><a href="computing.html"><i class="fa fa-check"></i><b>2</b> A few comments on computing</a></li>
<li class="chapter" data-level="3" data-path="directory.html"><a href="directory.html"><i class="fa fa-check"></i><b>3</b> Creating a Randomization Directory</a></li>
<li class="chapter" data-level="4" data-path="sequences.html"><a href="sequences.html"><i class="fa fa-check"></i><b>4</b> Generating Randomization Sequences</a>
<ul>
<li class="chapter" data-level="4.1" data-path="sequences.html"><a href="sequences.html#introduction"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="sequences.html"><a href="sequences.html#simple-randomization"><i class="fa fa-check"></i><b>4.2</b> Simple randomization</a></li>
<li class="chapter" data-level="4.3" data-path="sequences.html"><a href="sequences.html#blockedrandomization"><i class="fa fa-check"></i><b>4.3</b> Blocked randomization</a></li>
<li class="chapter" data-level="4.4" data-path="sequences.html"><a href="sequences.html#stratified-randomization"><i class="fa fa-check"></i><b>4.4</b> Stratified randomization</a></li>
<li class="chapter" data-level="4.5" data-path="sequences.html"><a href="sequences.html#matched-randomization"><i class="fa fa-check"></i><b>4.5</b> Matched randomization</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="randomizationdiagnostics.html"><a href="randomizationdiagnostics.html"><i class="fa fa-check"></i><b>5</b> Randomization Diagnostics</a></li>
<li class="chapter" data-level="6" data-path="masking.html"><a href="masking.html"><i class="fa fa-check"></i><b>6</b> Masking</a></li>
<li class="chapter" data-level="7" data-path="allocationconcealment.html"><a href="allocationconcealment.html"><i class="fa fa-check"></i><b>7</b> Allocation Concealment</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Francis I. Proctor Foundation <br> Guide to Randomization</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="sequences" class="section level1" number="4">
<h1><span class="header-section-number">Chapter 4</span> Generating Randomization Sequences</h1>
<p><em>Contributors: Ben Arnold</em></p>
<div id="introduction" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> Introduction</h2>
<p>This chapter includes guides for specific types of randomization. It includes code snippets to illustrate the different types of randomization. In the examples below, we focus on trials with two groups and equal allocation. Multi-arm trials are conceptually similar. Unequal allocation is similar as well, but raises particular issues around masking, described in the <a href="masking.html#masking">Masking</a> chapter.</p>
<p>In all of the examples, below, we will use masked examples with 2 letter per arm (so 4 letters total). The rationale for 2+ letters per arm is that if a single letter is accidentally unmasked, then the entire trial will not be unmasked.</p>
<p>These examples will carry forward into the next chapter on <a href="randomizationdiagnostics.html#randomizationdiagnostics">Randomization Diagnostics</a>. The template files stored in this guide’s Github respository (<strong>TBD</strong>) provide complete examples of how to put everything together.</p>
<p><em>Note</em> In thes examples, we have a list of study IDs that we bind to the allocation sequence. In some studies, such as those that use the REDCap randomization module, we would simply generate a random sequence of treatment assignments that are not bound to specific study IDs. For example, in REDCap’s randomization module it joins study IDs to a randomized treatment assignment (from the generated sequence) within REDCap itself. We simply upload the random sequence to REDCap.</p>
<p><strong>Essential background reading:</strong></p>
<p>Altman, D. G. &amp; Martin Bland, J. Treatment allocation in controlled trials: why randomise? BMJ 318, 1209–1209 (1999). <a href="https://pubmed.ncbi.nlm.nih.gov/10221955/" class="uri">https://pubmed.ncbi.nlm.nih.gov/10221955/</a> <span class="citation">[<a href="#ref-Altman1999-zc" role="doc-biblioref">1</a>]</span></p>
<p>Altman, D. G. &amp; Bland, J. M. How to randomise. BMJ 319, 703–704 (1999). <a href="https://pubmed.ncbi.nlm.nih.gov/10480833/" class="uri">https://pubmed.ncbi.nlm.nih.gov/10480833/</a> <span class="citation">[<a href="#ref-Altman1999-da" role="doc-biblioref">2</a>]</span></p>
<p>Schulz, K. F. &amp; Grimes, D. A. Generation of allocation sequences in randomised trials: chance, not choice. Lancet 359, 515–519 (2002). <a href="https://pubmed.ncbi.nlm.nih.gov/11853818/" class="uri">https://pubmed.ncbi.nlm.nih.gov/11853818/</a> <span class="citation">[<a href="#ref-Schulz2002-jf" role="doc-biblioref">3</a>]</span></p>
</div>
<div id="simple-randomization" class="section level2" number="4.2">
<h2><span class="header-section-number">4.2</span> Simple randomization</h2>
<blockquote>
<p><em>“No other allocation generation approach, irrespective of its complexity and sophistication, surpasses the unpredictability and bias prevention of simple randomisation.”</em> <span class="citation">[<a href="#ref-Schulz2002-jf" role="doc-biblioref">3</a>]</span></p>
</blockquote>
<p>High praise from masters of clinical trials! Simple randomization is the purest form of randomization. Patients (or clusters) are allocated to each arm with a known probability. For larger trials without specific design considerations this might be just the right tool. Many trials led by Proctor faculty favor simple randomization.</p>
<p>Schulz and Grimes highlight a downside, which is relevant for smaller trials or those with stratification. With simple randomization, at any point in the sequence the numbers of patients allocated to each treatment group will probably differ, which is not a major problem in terms of statistical efficiency (though perfectly balanced is statistically ideal). For a two-arm trial, the chance of pronounced imbalance becomes negligible with trial sizes greater than 200 <span class="citation">[<a href="#ref-Schulz2002-jf" role="doc-biblioref">3</a>,<a href="#ref-Lachin1988-gg" role="doc-biblioref">4</a>]</span>. But, if 20 participants are randomized with equal probability to two treatment groups, the chance of a 12:8 split (i.e., 60% A, 40% B) or worse is approximately 50%. For 100 participants, the chance of the same ratio (60:40 split) or worse is only 5% <span class="citation">[<a href="#ref-Friedman2015-ri" role="doc-biblioref">5</a>]</span>. For smaller trials and multi-center trials this chance imbalance could be a problem, and so many trials use blocking and/or stratification in the randomization sequence (next sections).</p>
<p>Additional advice from Schulz and Grimes <span class="citation">[<a href="#ref-Schulz2002-xo" role="doc-biblioref">6</a>]</span>:</p>
<blockquote>
<p><em>“Overall, investigators underuse simple randomisation and overuse fixed-block randomisation. For non-double-blinded trials larger than 200 participants, investigators should use simple randomisation more often and accept moderate disparities in group sizes.”</em></p>
</blockquote>
<p>Here is an example of generating a simple randomization sequence:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="sequences.html#cb1-1"></a><span class="co">#-------------------------------</span></span>
<span id="cb1-2"><a href="sequences.html#cb1-2"></a><span class="co"># Example of simple randomization</span></span>
<span id="cb1-3"><a href="sequences.html#cb1-3"></a><span class="co">#</span></span>
<span id="cb1-4"><a href="sequences.html#cb1-4"></a><span class="co"># 2 arm trial</span></span>
<span id="cb1-5"><a href="sequences.html#cb1-5"></a><span class="co"># 2 letters per arm (masked)</span></span>
<span id="cb1-6"><a href="sequences.html#cb1-6"></a><span class="co">#-------------------------------</span></span>
<span id="cb1-7"><a href="sequences.html#cb1-7"></a></span>
<span id="cb1-8"><a href="sequences.html#cb1-8"></a><span class="co">#-------------------------------</span></span>
<span id="cb1-9"><a href="sequences.html#cb1-9"></a><span class="co"># create a list of 1000 IDs.</span></span>
<span id="cb1-10"><a href="sequences.html#cb1-10"></a><span class="co"># in a real trial, we may already</span></span>
<span id="cb1-11"><a href="sequences.html#cb1-11"></a><span class="co"># have a list or sampling frame </span></span>
<span id="cb1-12"><a href="sequences.html#cb1-12"></a><span class="co"># to work with </span></span>
<span id="cb1-13"><a href="sequences.html#cb1-13"></a><span class="co">#</span></span>
<span id="cb1-14"><a href="sequences.html#cb1-14"></a><span class="co"># pro tip: always ensure your IDs start with a character</span></span>
<span id="cb1-15"><a href="sequences.html#cb1-15"></a><span class="co"># to prevent accidental conversion to numeric variables!</span></span>
<span id="cb1-16"><a href="sequences.html#cb1-16"></a><span class="co">#-------------------------------</span></span>
<span id="cb1-17"><a href="sequences.html#cb1-17"></a>nobs &lt;-<span class="st"> </span><span class="dv">1000</span></span>
<span id="cb1-18"><a href="sequences.html#cb1-18"></a>id &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;ID&quot;</span>,<span class="dv">1</span><span class="op">:</span>nobs)</span>
<span id="cb1-19"><a href="sequences.html#cb1-19"></a></span>
<span id="cb1-20"><a href="sequences.html#cb1-20"></a><span class="co">#-------------------------------</span></span>
<span id="cb1-21"><a href="sequences.html#cb1-21"></a><span class="co"># Identify letters for</span></span>
<span id="cb1-22"><a href="sequences.html#cb1-22"></a><span class="co"># the randomization</span></span>
<span id="cb1-23"><a href="sequences.html#cb1-23"></a><span class="co">#</span></span>
<span id="cb1-24"><a href="sequences.html#cb1-24"></a><span class="co"># In a masked trial, we would</span></span>
<span id="cb1-25"><a href="sequences.html#cb1-25"></a><span class="co"># start with placeholder letters</span></span>
<span id="cb1-26"><a href="sequences.html#cb1-26"></a><span class="co"># to vet the sequence generation</span></span>
<span id="cb1-27"><a href="sequences.html#cb1-27"></a><span class="co"># and then change them for the</span></span>
<span id="cb1-28"><a href="sequences.html#cb1-28"></a><span class="co"># final randomization.</span></span>
<span id="cb1-29"><a href="sequences.html#cb1-29"></a><span class="co"># See step 3 in the Overview</span></span>
<span id="cb1-30"><a href="sequences.html#cb1-30"></a><span class="co">#</span></span>
<span id="cb1-31"><a href="sequences.html#cb1-31"></a><span class="co"># In this example, we use</span></span>
<span id="cb1-32"><a href="sequences.html#cb1-32"></a><span class="co"># A, B, T, V</span></span>
<span id="cb1-33"><a href="sequences.html#cb1-33"></a><span class="co">#-------------------------------</span></span>
<span id="cb1-34"><a href="sequences.html#cb1-34"></a>rand_letters &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;B&quot;</span>,<span class="st">&quot;T&quot;</span>,<span class="st">&quot;V&quot;</span>)</span>
<span id="cb1-35"><a href="sequences.html#cb1-35"></a></span>
<span id="cb1-36"><a href="sequences.html#cb1-36"></a><span class="co">#-------------------------------</span></span>
<span id="cb1-37"><a href="sequences.html#cb1-37"></a><span class="co"># set a seed</span></span>
<span id="cb1-38"><a href="sequences.html#cb1-38"></a><span class="co"># </span></span>
<span id="cb1-39"><a href="sequences.html#cb1-39"></a><span class="co"># this is essential for </span></span>
<span id="cb1-40"><a href="sequences.html#cb1-40"></a><span class="co"># creating a reproducible </span></span>
<span id="cb1-41"><a href="sequences.html#cb1-41"></a><span class="co"># sequence!  After vetting the</span></span>
<span id="cb1-42"><a href="sequences.html#cb1-42"></a><span class="co"># randomization with the broader</span></span>
<span id="cb1-43"><a href="sequences.html#cb1-43"></a><span class="co"># study team (steps 4-5 in the Overview), </span></span>
<span id="cb1-44"><a href="sequences.html#cb1-44"></a><span class="co"># we can change the seed to create a new</span></span>
<span id="cb1-45"><a href="sequences.html#cb1-45"></a><span class="co"># (protected) sequence</span></span>
<span id="cb1-46"><a href="sequences.html#cb1-46"></a><span class="co">#-------------------------------</span></span>
<span id="cb1-47"><a href="sequences.html#cb1-47"></a><span class="kw">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb1-48"><a href="sequences.html#cb1-48"></a></span>
<span id="cb1-49"><a href="sequences.html#cb1-49"></a><span class="co">#-------------------------------</span></span>
<span id="cb1-50"><a href="sequences.html#cb1-50"></a><span class="co"># generate the sequence</span></span>
<span id="cb1-51"><a href="sequences.html#cb1-51"></a><span class="co">#</span></span>
<span id="cb1-52"><a href="sequences.html#cb1-52"></a><span class="co"># the sample() function</span></span>
<span id="cb1-53"><a href="sequences.html#cb1-53"></a><span class="co"># samples the rand_letters</span></span>
<span id="cb1-54"><a href="sequences.html#cb1-54"></a><span class="co"># with equal probability</span></span>
<span id="cb1-55"><a href="sequences.html#cb1-55"></a><span class="co"># up to the number of IDs</span></span>
<span id="cb1-56"><a href="sequences.html#cb1-56"></a><span class="co"># using replacement</span></span>
<span id="cb1-57"><a href="sequences.html#cb1-57"></a><span class="co">#-------------------------------</span></span>
<span id="cb1-58"><a href="sequences.html#cb1-58"></a>tr_masked &lt;-<span class="st"> </span><span class="kw">sample</span>(rand_letters, <span class="dt">size =</span> <span class="kw">length</span>(id), <span class="dt">replace =</span> <span class="ot">TRUE</span>)</span>
<span id="cb1-59"><a href="sequences.html#cb1-59"></a></span>
<span id="cb1-60"><a href="sequences.html#cb1-60"></a><span class="co">#-------------------------------</span></span>
<span id="cb1-61"><a href="sequences.html#cb1-61"></a><span class="co"># combine the IDs with the</span></span>
<span id="cb1-62"><a href="sequences.html#cb1-62"></a><span class="co"># sequence in a data.frame</span></span>
<span id="cb1-63"><a href="sequences.html#cb1-63"></a><span class="co">#</span></span>
<span id="cb1-64"><a href="sequences.html#cb1-64"></a><span class="co"># this object would be stored</span></span>
<span id="cb1-65"><a href="sequences.html#cb1-65"></a><span class="co"># in the Randomization Directory</span></span>
<span id="cb1-66"><a href="sequences.html#cb1-66"></a><span class="co"># as a .csv file</span></span>
<span id="cb1-67"><a href="sequences.html#cb1-67"></a><span class="co">#-------------------------------</span></span>
<span id="cb1-68"><a href="sequences.html#cb1-68"></a>rand_seq &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">id =</span> id, <span class="dt">tr_masked =</span> tr_masked)</span>
<span id="cb1-69"><a href="sequences.html#cb1-69"></a></span>
<span id="cb1-70"><a href="sequences.html#cb1-70"></a></span>
<span id="cb1-71"><a href="sequences.html#cb1-71"></a><span class="co">#-------------------------------</span></span>
<span id="cb1-72"><a href="sequences.html#cb1-72"></a><span class="co"># for the sake of example,</span></span>
<span id="cb1-73"><a href="sequences.html#cb1-73"></a><span class="co"># unmask and examine the </span></span>
<span id="cb1-74"><a href="sequences.html#cb1-74"></a><span class="co"># allocation. </span></span>
<span id="cb1-75"><a href="sequences.html#cb1-75"></a><span class="co">#</span></span>
<span id="cb1-76"><a href="sequences.html#cb1-76"></a><span class="co"># Pretend letters A and T </span></span>
<span id="cb1-77"><a href="sequences.html#cb1-77"></a><span class="co"># are for placebo</span></span>
<span id="cb1-78"><a href="sequences.html#cb1-78"></a><span class="co">#-------------------------------</span></span>
<span id="cb1-79"><a href="sequences.html#cb1-79"></a>tr &lt;-<span class="st"> </span><span class="kw">ifelse</span>(tr_masked <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;T&quot;</span>),<span class="st">&quot;Placebo&quot;</span>,<span class="st">&quot;Treatment&quot;</span>)</span>
<span id="cb1-80"><a href="sequences.html#cb1-80"></a><span class="kw">table</span>(tr)</span></code></pre></div>
<pre><code>## tr
##   Placebo Treatment 
##       506       494</code></pre>
<p>In this example, 51% of the participants were allocated to placebom and 49% were allocated to treatment — a pretty good balance! This would be expected given the trial’s large size.</p>
<p>Try running the code above with <code>nobs &lt;- 80</code> to see what a typical randomization looks like:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="sequences.html#cb3-1"></a><span class="co">#-------------------------------</span></span>
<span id="cb3-2"><a href="sequences.html#cb3-2"></a><span class="co"># From the above example</span></span>
<span id="cb3-3"><a href="sequences.html#cb3-3"></a><span class="co"># create a function</span></span>
<span id="cb3-4"><a href="sequences.html#cb3-4"></a><span class="co"># that takes as arguments</span></span>
<span id="cb3-5"><a href="sequences.html#cb3-5"></a><span class="co"># a vector of IDs and</span></span>
<span id="cb3-6"><a href="sequences.html#cb3-6"></a><span class="co"># masked treatment letters</span></span>
<span id="cb3-7"><a href="sequences.html#cb3-7"></a><span class="co">#-------------------------------</span></span>
<span id="cb3-8"><a href="sequences.html#cb3-8"></a>randomize_simple &lt;-<span class="st"> </span><span class="cf">function</span>(ids, letters) {</span>
<span id="cb3-9"><a href="sequences.html#cb3-9"></a>  tr_masked &lt;-<span class="st"> </span><span class="kw">sample</span>(rand_letters, <span class="dt">size =</span> <span class="kw">length</span>(id), <span class="dt">replace =</span> <span class="ot">TRUE</span>)</span>
<span id="cb3-10"><a href="sequences.html#cb3-10"></a>  <span class="kw">return</span>( <span class="kw">data.frame</span>(<span class="dt">id =</span> ids, <span class="dt">tr_masked =</span> tr_masked) )</span>
<span id="cb3-11"><a href="sequences.html#cb3-11"></a>}</span>
<span id="cb3-12"><a href="sequences.html#cb3-12"></a></span>
<span id="cb3-13"><a href="sequences.html#cb3-13"></a><span class="co">#-------------------------------</span></span>
<span id="cb3-14"><a href="sequences.html#cb3-14"></a><span class="co"># setting trial size, creating IDs</span></span>
<span id="cb3-15"><a href="sequences.html#cb3-15"></a><span class="co"># and identifying letters,</span></span>
<span id="cb3-16"><a href="sequences.html#cb3-16"></a><span class="co"># as in the above example</span></span>
<span id="cb3-17"><a href="sequences.html#cb3-17"></a><span class="co">#-------------------------------</span></span>
<span id="cb3-18"><a href="sequences.html#cb3-18"></a>nobs &lt;-<span class="st"> </span><span class="dv">80</span></span>
<span id="cb3-19"><a href="sequences.html#cb3-19"></a>id &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;ID&quot;</span>,<span class="dv">1</span><span class="op">:</span>nobs)</span>
<span id="cb3-20"><a href="sequences.html#cb3-20"></a>rand_letters &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;B&quot;</span>,<span class="st">&quot;T&quot;</span>,<span class="st">&quot;V&quot;</span>)</span>
<span id="cb3-21"><a href="sequences.html#cb3-21"></a><span class="co">#-------------------------------</span></span>
<span id="cb3-22"><a href="sequences.html#cb3-22"></a><span class="co"># generating a new sequence</span></span>
<span id="cb3-23"><a href="sequences.html#cb3-23"></a><span class="co"># using the randomize_simple()</span></span>
<span id="cb3-24"><a href="sequences.html#cb3-24"></a><span class="co"># function</span></span>
<span id="cb3-25"><a href="sequences.html#cb3-25"></a><span class="co">#-------------------------------</span></span>
<span id="cb3-26"><a href="sequences.html#cb3-26"></a><span class="kw">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb3-27"><a href="sequences.html#cb3-27"></a>rand_seq2 &lt;-<span class="st"> </span><span class="kw">randomize_simple</span>(<span class="dt">ids =</span> id, <span class="dt">letters =</span> rand_letters)</span>
<span id="cb3-28"><a href="sequences.html#cb3-28"></a>rand_seq2<span class="op">$</span>tr &lt;-<span class="st"> </span><span class="kw">ifelse</span>(rand_seq2<span class="op">$</span>tr_masked <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;T&quot;</span>),<span class="st">&quot;Placebo&quot;</span>,<span class="st">&quot;Treatment&quot;</span>)</span>
<span id="cb3-29"><a href="sequences.html#cb3-29"></a><span class="kw">table</span>(rand_seq2<span class="op">$</span>tr)</span></code></pre></div>
<pre><code>## 
##   Placebo Treatment 
##        48        32</code></pre>
<p>With the same seed, 48/80 (60%) are allocated to placebo, which is not ideal.</p>
<p>Blocking can prevent this type of chance imbalance.</p>
</div>
<div id="blockedrandomization" class="section level2" number="4.3">
<h2><span class="header-section-number">4.3</span> Blocked randomization</h2>
<blockquote>
<p><em>“The method of restricted randomisation is used to balance sample sizes. That balance usually enhances statistical power and addresses any time trends that might exist in treatment efficacy and outcome measurement during the course of a trial. Moreover, restricted randomisation within strata becomes essential for investigators to attain the benefits of stratification. Thus, reasonable scientific justification lends support to restriction.”</em> <span class="citation">[<a href="#ref-Schulz2002-xo" role="doc-biblioref">6</a>]</span></p>
</blockquote>
<p>Blocking is one form of restricted randomization. It is often combined with other forms of restriction, including stratification and matching (next sections).</p>
<p>With blocking, the numbers of patients randomized in the two groups can never differ by more than half the block length. If the trial uses multiple letters to mask groups, then the number of patients in the two groups can never differ by more than half the block length divided by the number of letters per group.</p>
<p>A simple randomization sequence will translate into a random string of letters, such as <code>A A B B B B A B</code> for the first eight patients. If we consider blocks of four at a time, there are only 6 ways in which two patients get <code>A</code> and two patients get <code>B</code>: 1: <code>A A B B</code> 2: <code>A B A B</code> 3: <code>A B B A</code> 4: <code>B B A A</code> 5: <code>B A B A</code> 6: <code>B A A B</code>.</p>
<p>Since this could create a predictable sequence within blocks, we strongly recommend the use of randomly permuted block lengths <span class="citation">[<a href="#ref-Schulz2002-xo" role="doc-biblioref">6</a>]</span>. For example, using block sizes of 2, 4 and 6, each with a secret probability. Note that the block length needs to be a multiple of the number of letters used in the randomization scheme and the sum of the block size probabilities must sum to 1. Blocks that are too long do not preserve balance as well. For a two arm trial, we could use block sizes of 4 and 6. If each group is masked with multiple letters, then we use slightly longer block lengths – see the example below.</p>
<blockquote>
<p>It is best practice to keep the block sizes and block probabilities secret to help with allocation concealment <span class="citation">[<a href="#ref-Schulz1995-lb" role="doc-biblioref">7</a>]</span>.</p>
</blockquote>
<p>Here is an example of generating a blocked randomization sequence. Drawing from the basics in the example above, the sequence generation uses permuted blocks of length 8 and 12 (multiples of the 4 masked letters used). Since there are 2 letters per group, the maximum sequence length divided by number of letters per group (12/2) = 6, so the most the sequence could ever be imbalanced is 1/2*6 = 3</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="sequences.html#cb5-1"></a><span class="co">#-------------------------------</span></span>
<span id="cb5-2"><a href="sequences.html#cb5-2"></a><span class="co"># setting trial size, creating IDs</span></span>
<span id="cb5-3"><a href="sequences.html#cb5-3"></a><span class="co"># and identifying letters,</span></span>
<span id="cb5-4"><a href="sequences.html#cb5-4"></a><span class="co"># as in the above example</span></span>
<span id="cb5-5"><a href="sequences.html#cb5-5"></a><span class="co">#----------------------------</span></span>
<span id="cb5-6"><a href="sequences.html#cb5-6"></a>nobs &lt;-<span class="st"> </span><span class="dv">80</span></span>
<span id="cb5-7"><a href="sequences.html#cb5-7"></a>id &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;ID&quot;</span>,<span class="dv">1</span><span class="op">:</span>nobs)</span>
<span id="cb5-8"><a href="sequences.html#cb5-8"></a>rand_letters &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;B&quot;</span>,<span class="st">&quot;T&quot;</span>,<span class="st">&quot;V&quot;</span>)</span>
<span id="cb5-9"><a href="sequences.html#cb5-9"></a></span>
<span id="cb5-10"><a href="sequences.html#cb5-10"></a><span class="co">#-------------------------------</span></span>
<span id="cb5-11"><a href="sequences.html#cb5-11"></a><span class="co"># set a seed for reproducibility!</span></span>
<span id="cb5-12"><a href="sequences.html#cb5-12"></a><span class="co">#-------------------------------</span></span>
<span id="cb5-13"><a href="sequences.html#cb5-13"></a><span class="kw">set.seed</span>(<span class="dv">233</span>)</span>
<span id="cb5-14"><a href="sequences.html#cb5-14"></a></span>
<span id="cb5-15"><a href="sequences.html#cb5-15"></a><span class="co">#-------------------------------</span></span>
<span id="cb5-16"><a href="sequences.html#cb5-16"></a><span class="co"># generate the permuted block</span></span>
<span id="cb5-17"><a href="sequences.html#cb5-17"></a><span class="co"># sequence</span></span>
<span id="cb5-18"><a href="sequences.html#cb5-18"></a><span class="co"># block lengths of 8, 12</span></span>
<span id="cb5-19"><a href="sequences.html#cb5-19"></a><span class="co"># with probabilities 0.7, 0.3</span></span>
<span id="cb5-20"><a href="sequences.html#cb5-20"></a><span class="co">#-------------------------------</span></span>
<span id="cb5-21"><a href="sequences.html#cb5-21"></a><span class="co"># the number of permuted blocks can be long, much longer than needed</span></span>
<span id="cb5-22"><a href="sequences.html#cb5-22"></a>nblocks &lt;-<span class="st"> </span><span class="dv">100</span></span>
<span id="cb5-23"><a href="sequences.html#cb5-23"></a>block_len &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="dv">8</span>,<span class="dv">12</span>),<span class="dt">size=</span>nblocks,<span class="dt">replace=</span><span class="ot">TRUE</span>,<span class="dt">prob=</span><span class="kw">c</span>(<span class="fl">0.7</span>,<span class="fl">0.3</span>))</span>
<span id="cb5-24"><a href="sequences.html#cb5-24"></a></span>
<span id="cb5-25"><a href="sequences.html#cb5-25"></a><span class="co">#-------------------------------</span></span>
<span id="cb5-26"><a href="sequences.html#cb5-26"></a><span class="co"># expand the sequence, keep</span></span>
<span id="cb5-27"><a href="sequences.html#cb5-27"></a><span class="co"># track of the block lengths</span></span>
<span id="cb5-28"><a href="sequences.html#cb5-28"></a><span class="co">#</span></span>
<span id="cb5-29"><a href="sequences.html#cb5-29"></a><span class="co"># (note: in this step and the next</span></span>
<span id="cb5-30"><a href="sequences.html#cb5-30"></a><span class="co">#  there is a more transparent</span></span>
<span id="cb5-31"><a href="sequences.html#cb5-31"></a><span class="co">#  way to code this using dplyr/tidyr,</span></span>
<span id="cb5-32"><a href="sequences.html#cb5-32"></a><span class="co">#  but we are trying to rely,</span></span>
<span id="cb5-33"><a href="sequences.html#cb5-33"></a><span class="co">#  when possible, on base R for stability)</span></span>
<span id="cb5-34"><a href="sequences.html#cb5-34"></a><span class="co">#-------------------------------</span></span>
<span id="cb5-35"><a href="sequences.html#cb5-35"></a>d_seq &lt;-<span class="st"> </span><span class="kw">data.frame</span>( </span>
<span id="cb5-36"><a href="sequences.html#cb5-36"></a>  <span class="dt">block_id =</span> <span class="kw">rep</span>(<span class="kw">seq_len</span>(nblocks), block_len), </span>
<span id="cb5-37"><a href="sequences.html#cb5-37"></a>  <span class="dt">block_size =</span> <span class="kw">rep</span>(block_len, block_len)</span>
<span id="cb5-38"><a href="sequences.html#cb5-38"></a>  )</span>
<span id="cb5-39"><a href="sequences.html#cb5-39"></a></span>
<span id="cb5-40"><a href="sequences.html#cb5-40"></a><span class="co">#-------------------------------</span></span>
<span id="cb5-41"><a href="sequences.html#cb5-41"></a><span class="co"># generate the allocation sequence</span></span>
<span id="cb5-42"><a href="sequences.html#cb5-42"></a><span class="co">#</span></span>
<span id="cb5-43"><a href="sequences.html#cb5-43"></a><span class="co"># equal allocation within </span></span>
<span id="cb5-44"><a href="sequences.html#cb5-44"></a><span class="co"># permuted blocks of size 8 or 12</span></span>
<span id="cb5-45"><a href="sequences.html#cb5-45"></a><span class="co">#</span></span>
<span id="cb5-46"><a href="sequences.html#cb5-46"></a><span class="co"># the loop below iterates through</span></span>
<span id="cb5-47"><a href="sequences.html#cb5-47"></a><span class="co"># each block generated above,</span></span>
<span id="cb5-48"><a href="sequences.html#cb5-48"></a><span class="co"># and randomly samples the masked</span></span>
<span id="cb5-49"><a href="sequences.html#cb5-49"></a><span class="co"># letters (rand_letters) for </span></span>
<span id="cb5-50"><a href="sequences.html#cb5-50"></a><span class="co"># either 8 or 12, depending on the</span></span>
<span id="cb5-51"><a href="sequences.html#cb5-51"></a><span class="co"># randomly permuted block length</span></span>
<span id="cb5-52"><a href="sequences.html#cb5-52"></a><span class="co">#-------------------------------</span></span>
<span id="cb5-53"><a href="sequences.html#cb5-53"></a>d_seq<span class="op">$</span>tr_masked &lt;-<span class="st"> </span><span class="kw">as.character</span>(<span class="ot">NA</span>)</span>
<span id="cb5-54"><a href="sequences.html#cb5-54"></a><span class="cf">for</span>(blocki <span class="cf">in</span> <span class="kw">unique</span>(d_seq<span class="op">$</span>block_id) ) {</span>
<span id="cb5-55"><a href="sequences.html#cb5-55"></a>  d_seq<span class="op">$</span>tr_masked[d_seq<span class="op">$</span>block_id <span class="op">==</span><span class="st"> </span>blocki] &lt;-<span class="st"> </span><span class="kw">ifelse</span>(</span>
<span id="cb5-56"><a href="sequences.html#cb5-56"></a>    d_seq<span class="op">$</span>block_size[d_seq<span class="op">$</span>block_id <span class="op">==</span><span class="st"> </span>blocki] <span class="op">==</span><span class="st"> </span><span class="dv">8</span>, </span>
<span id="cb5-57"><a href="sequences.html#cb5-57"></a>    <span class="kw">sample</span>(<span class="kw">rep</span>(rand_letters,<span class="dv">2</span>), <span class="dt">size=</span><span class="dv">8</span>,  <span class="dt">replace=</span><span class="ot">FALSE</span>),</span>
<span id="cb5-58"><a href="sequences.html#cb5-58"></a>    <span class="kw">sample</span>(<span class="kw">rep</span>(rand_letters,<span class="dv">3</span>), <span class="dt">size=</span><span class="dv">12</span>, <span class="dt">replace=</span><span class="ot">FALSE</span>)</span>
<span id="cb5-59"><a href="sequences.html#cb5-59"></a>    )</span>
<span id="cb5-60"><a href="sequences.html#cb5-60"></a>}</span>
<span id="cb5-61"><a href="sequences.html#cb5-61"></a></span>
<span id="cb5-62"><a href="sequences.html#cb5-62"></a><span class="co">#-------------------------------</span></span>
<span id="cb5-63"><a href="sequences.html#cb5-63"></a><span class="co"># for the sake of example,</span></span>
<span id="cb5-64"><a href="sequences.html#cb5-64"></a><span class="co"># unmask and examine the </span></span>
<span id="cb5-65"><a href="sequences.html#cb5-65"></a><span class="co"># allocation for the first nobs</span></span>
<span id="cb5-66"><a href="sequences.html#cb5-66"></a><span class="co">#</span></span>
<span id="cb5-67"><a href="sequences.html#cb5-67"></a><span class="co"># Pretend letters A and T </span></span>
<span id="cb5-68"><a href="sequences.html#cb5-68"></a><span class="co"># are for placebo</span></span>
<span id="cb5-69"><a href="sequences.html#cb5-69"></a><span class="co">#-------------------------------</span></span>
<span id="cb5-70"><a href="sequences.html#cb5-70"></a>d_seq<span class="op">$</span>tr &lt;-<span class="st"> </span><span class="kw">ifelse</span>(d_seq<span class="op">$</span>tr_masked <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;T&quot;</span>),<span class="st">&quot;Placebo&quot;</span>,<span class="st">&quot;Treatment&quot;</span>)</span>
<span id="cb5-71"><a href="sequences.html#cb5-71"></a><span class="kw">table</span>(d_seq<span class="op">$</span>tr[<span class="dv">1</span><span class="op">:</span>nobs])</span></code></pre></div>
<pre><code>## 
##   Placebo Treatment 
##        41        39</code></pre>
<p>In this example, the treatment sequence is now very well balanced with a small sample size of just 80 units. In the next chapter on <a href="randomizationdiagnostics.html#randomizationdiagnostics">Randomization Diagnostics</a>, we will illustrate how to examine balance across arms over cumulative enrollment as an internal validity check to ensure the sequence is consistent with the blocking scheme.</p>
</div>
<div id="stratified-randomization" class="section level2" number="4.4">
<h2><span class="header-section-number">4.4</span> Stratified randomization</h2>
<p>Stratified randomization is another form of restricted randomization. By creating separate randomization sequences within strata, it ensures through design that treatment allocation will be balanced within each stratum (on average). A common example is center in a multicenter trial. By generating a separate randomization sequence for each center that recruits patients, the trial ensures that a single center will not allocate most of its patients to just one of the arms (just through chance). Since stratification shrinks the effective size of the randomization sequence within each stratum, we strongly recommend combining stratification with permuted blocks to ensure good balance within strata.</p>
<p>The process of generating a stratified sequence is to essentially repeat the steps for block randomization within each stratum. If randomization is stratified by clinical site, then each site would have its own randomization sequence.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="sequences.html#cb7-1"></a><span class="co">#-------------------------------</span></span>
<span id="cb7-2"><a href="sequences.html#cb7-2"></a><span class="co"># setting the number of sites</span></span>
<span id="cb7-3"><a href="sequences.html#cb7-3"></a><span class="co"># and identifying letters,</span></span>
<span id="cb7-4"><a href="sequences.html#cb7-4"></a><span class="co"># as in the above example</span></span>
<span id="cb7-5"><a href="sequences.html#cb7-5"></a><span class="co">#</span></span>
<span id="cb7-6"><a href="sequences.html#cb7-6"></a><span class="co"># in this example, we</span></span>
<span id="cb7-7"><a href="sequences.html#cb7-7"></a><span class="co"># create 7 different sites, </span></span>
<span id="cb7-8"><a href="sequences.html#cb7-8"></a><span class="co"># mimicking a multi-center</span></span>
<span id="cb7-9"><a href="sequences.html#cb7-9"></a><span class="co"># RCT. Other examples of </span></span>
<span id="cb7-10"><a href="sequences.html#cb7-10"></a><span class="co"># stratification variables</span></span>
<span id="cb7-11"><a href="sequences.html#cb7-11"></a><span class="co"># could be administrative district</span></span>
<span id="cb7-12"><a href="sequences.html#cb7-12"></a><span class="co"># or baseline characteristics.# </span></span>
<span id="cb7-13"><a href="sequences.html#cb7-13"></a><span class="co">#----------------------------</span></span>
<span id="cb7-14"><a href="sequences.html#cb7-14"></a>study_sites  &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;site&quot;</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">7</span>)</span>
<span id="cb7-15"><a href="sequences.html#cb7-15"></a>rand_letters &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;B&quot;</span>,<span class="st">&quot;T&quot;</span>,<span class="st">&quot;V&quot;</span>)</span>
<span id="cb7-16"><a href="sequences.html#cb7-16"></a></span>
<span id="cb7-17"><a href="sequences.html#cb7-17"></a><span class="co">#-------------------------------</span></span>
<span id="cb7-18"><a href="sequences.html#cb7-18"></a><span class="co"># set a seed for reproducibility!</span></span>
<span id="cb7-19"><a href="sequences.html#cb7-19"></a><span class="co">#-------------------------------</span></span>
<span id="cb7-20"><a href="sequences.html#cb7-20"></a><span class="kw">set.seed</span>(<span class="dv">455</span>)</span>
<span id="cb7-21"><a href="sequences.html#cb7-21"></a></span>
<span id="cb7-22"><a href="sequences.html#cb7-22"></a><span class="co">#-------------------------------</span></span>
<span id="cb7-23"><a href="sequences.html#cb7-23"></a><span class="co"># generate the permuted block</span></span>
<span id="cb7-24"><a href="sequences.html#cb7-24"></a><span class="co"># sequence</span></span>
<span id="cb7-25"><a href="sequences.html#cb7-25"></a><span class="co"># block lengths of 8, 12</span></span>
<span id="cb7-26"><a href="sequences.html#cb7-26"></a><span class="co"># with probabilities 0.7, 0.3</span></span>
<span id="cb7-27"><a href="sequences.html#cb7-27"></a><span class="co">#-------------------------------</span></span>
<span id="cb7-28"><a href="sequences.html#cb7-28"></a><span class="co"># the number of permuted blocks can be long, much longer than needed</span></span>
<span id="cb7-29"><a href="sequences.html#cb7-29"></a>nblocks_persite &lt;-<span class="st"> </span><span class="dv">100</span></span>
<span id="cb7-30"><a href="sequences.html#cb7-30"></a>block_len &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="dv">8</span>,<span class="dv">12</span>),<span class="dt">size=</span>nblocks_persite<span class="op">*</span><span class="kw">length</span>(study_sites),<span class="dt">replace=</span><span class="ot">TRUE</span>,<span class="dt">prob=</span><span class="kw">c</span>(<span class="fl">0.7</span>,<span class="fl">0.3</span>))</span>
<span id="cb7-31"><a href="sequences.html#cb7-31"></a></span>
<span id="cb7-32"><a href="sequences.html#cb7-32"></a><span class="co">#-------------------------------</span></span>
<span id="cb7-33"><a href="sequences.html#cb7-33"></a><span class="co"># expand the sequence, keep</span></span>
<span id="cb7-34"><a href="sequences.html#cb7-34"></a><span class="co"># track of sites, block IDs and</span></span>
<span id="cb7-35"><a href="sequences.html#cb7-35"></a><span class="co"># the block lengths</span></span>
<span id="cb7-36"><a href="sequences.html#cb7-36"></a><span class="co">#</span></span>
<span id="cb7-37"><a href="sequences.html#cb7-37"></a><span class="co"># (note: in this step and the next</span></span>
<span id="cb7-38"><a href="sequences.html#cb7-38"></a><span class="co">#  there is a more transparent</span></span>
<span id="cb7-39"><a href="sequences.html#cb7-39"></a><span class="co">#  way to code this using dplyr/tidyr,</span></span>
<span id="cb7-40"><a href="sequences.html#cb7-40"></a><span class="co">#  but we are trying to rely,</span></span>
<span id="cb7-41"><a href="sequences.html#cb7-41"></a><span class="co">#  when possible, on base R for stability)</span></span>
<span id="cb7-42"><a href="sequences.html#cb7-42"></a><span class="co">#-------------------------------</span></span>
<span id="cb7-43"><a href="sequences.html#cb7-43"></a>d_seq &lt;-<span class="st"> </span><span class="kw">data.frame</span>( </span>
<span id="cb7-44"><a href="sequences.html#cb7-44"></a>  <span class="dt">site_id    =</span> <span class="kw">rep</span>( <span class="kw">rep</span>(study_sites, <span class="kw">rep</span>(nblocks_persite,<span class="kw">length</span>(study_sites))), block_len),</span>
<span id="cb7-45"><a href="sequences.html#cb7-45"></a>  <span class="dt">block_id   =</span> <span class="kw">rep</span>(<span class="kw">seq_len</span>(nblocks_persite<span class="op">*</span><span class="kw">length</span>(study_sites)), block_len), </span>
<span id="cb7-46"><a href="sequences.html#cb7-46"></a>  <span class="dt">block_size =</span> <span class="kw">rep</span>(block_len, block_len)</span>
<span id="cb7-47"><a href="sequences.html#cb7-47"></a>  )</span>
<span id="cb7-48"><a href="sequences.html#cb7-48"></a>d_seq<span class="op">$</span>id &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;ID&quot;</span>,<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(d_seq))</span>
<span id="cb7-49"><a href="sequences.html#cb7-49"></a></span>
<span id="cb7-50"><a href="sequences.html#cb7-50"></a><span class="co">#-------------------------------</span></span>
<span id="cb7-51"><a href="sequences.html#cb7-51"></a><span class="co"># generate the allocation sequence</span></span>
<span id="cb7-52"><a href="sequences.html#cb7-52"></a><span class="co">#</span></span>
<span id="cb7-53"><a href="sequences.html#cb7-53"></a><span class="co"># equal allocation within </span></span>
<span id="cb7-54"><a href="sequences.html#cb7-54"></a><span class="co"># permuted blocks of size 8 or 12</span></span>
<span id="cb7-55"><a href="sequences.html#cb7-55"></a><span class="co">#</span></span>
<span id="cb7-56"><a href="sequences.html#cb7-56"></a><span class="co"># the loop below iterates through</span></span>
<span id="cb7-57"><a href="sequences.html#cb7-57"></a><span class="co"># each block generated above,</span></span>
<span id="cb7-58"><a href="sequences.html#cb7-58"></a><span class="co"># and randomly samples the masked</span></span>
<span id="cb7-59"><a href="sequences.html#cb7-59"></a><span class="co"># letters (rand_letters) for </span></span>
<span id="cb7-60"><a href="sequences.html#cb7-60"></a><span class="co"># either 8 or 12, depending on the</span></span>
<span id="cb7-61"><a href="sequences.html#cb7-61"></a><span class="co"># randomly permuted block length</span></span>
<span id="cb7-62"><a href="sequences.html#cb7-62"></a><span class="co">#-------------------------------</span></span>
<span id="cb7-63"><a href="sequences.html#cb7-63"></a>d_seq<span class="op">$</span>tr_masked &lt;-<span class="st"> </span><span class="kw">as.character</span>(<span class="ot">NA</span>)</span>
<span id="cb7-64"><a href="sequences.html#cb7-64"></a><span class="cf">for</span>(blocki <span class="cf">in</span> <span class="kw">unique</span>(d_seq<span class="op">$</span>block_id) ) {</span>
<span id="cb7-65"><a href="sequences.html#cb7-65"></a>  d_seq<span class="op">$</span>tr_masked[d_seq<span class="op">$</span>block_id <span class="op">==</span><span class="st"> </span>blocki] &lt;-<span class="st"> </span><span class="kw">ifelse</span>(</span>
<span id="cb7-66"><a href="sequences.html#cb7-66"></a>    d_seq<span class="op">$</span>block_size[d_seq<span class="op">$</span>block_id <span class="op">==</span><span class="st"> </span>blocki] <span class="op">==</span><span class="st"> </span><span class="dv">8</span>, </span>
<span id="cb7-67"><a href="sequences.html#cb7-67"></a>    <span class="kw">sample</span>(<span class="kw">rep</span>(rand_letters,<span class="dv">2</span>), <span class="dt">size=</span><span class="dv">8</span>,  <span class="dt">replace=</span><span class="ot">FALSE</span>),</span>
<span id="cb7-68"><a href="sequences.html#cb7-68"></a>    <span class="kw">sample</span>(<span class="kw">rep</span>(rand_letters,<span class="dv">3</span>), <span class="dt">size=</span><span class="dv">12</span>, <span class="dt">replace=</span><span class="ot">FALSE</span>)</span>
<span id="cb7-69"><a href="sequences.html#cb7-69"></a>    )</span>
<span id="cb7-70"><a href="sequences.html#cb7-70"></a>}</span>
<span id="cb7-71"><a href="sequences.html#cb7-71"></a></span>
<span id="cb7-72"><a href="sequences.html#cb7-72"></a><span class="co">#-------------------------------</span></span>
<span id="cb7-73"><a href="sequences.html#cb7-73"></a><span class="co"># for the sake of example,</span></span>
<span id="cb7-74"><a href="sequences.html#cb7-74"></a><span class="co"># unmask and examine the </span></span>
<span id="cb7-75"><a href="sequences.html#cb7-75"></a><span class="co"># allocation for the first nobs_persite</span></span>
<span id="cb7-76"><a href="sequences.html#cb7-76"></a><span class="co">#</span></span>
<span id="cb7-77"><a href="sequences.html#cb7-77"></a><span class="co"># Pretend letters A and T </span></span>
<span id="cb7-78"><a href="sequences.html#cb7-78"></a><span class="co"># are for placebo</span></span>
<span id="cb7-79"><a href="sequences.html#cb7-79"></a><span class="co">#-------------------------------</span></span>
<span id="cb7-80"><a href="sequences.html#cb7-80"></a>d_seq<span class="op">$</span>tr &lt;-<span class="st"> </span><span class="kw">ifelse</span>(d_seq<span class="op">$</span>tr_masked <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;T&quot;</span>),<span class="st">&quot;Placebo&quot;</span>,<span class="st">&quot;Treatment&quot;</span>)</span>
<span id="cb7-81"><a href="sequences.html#cb7-81"></a></span>
<span id="cb7-82"><a href="sequences.html#cb7-82"></a><span class="co"># print the number of units allocated to each group by site</span></span>
<span id="cb7-83"><a href="sequences.html#cb7-83"></a><span class="co"># this admittedly uses archaic base R code (not tidy R)</span></span>
<span id="cb7-84"><a href="sequences.html#cb7-84"></a><span class="co"># because we are trying to rely only on base R for stability</span></span>
<span id="cb7-85"><a href="sequences.html#cb7-85"></a><span class="co"># specify the sequence length desired for each stratum</span></span>
<span id="cb7-86"><a href="sequences.html#cb7-86"></a>nobs_persite &lt;-<span class="st"> </span><span class="dv">100</span></span>
<span id="cb7-87"><a href="sequences.html#cb7-87"></a>site_tr &lt;-<span class="st"> </span><span class="kw">tapply</span>(d_seq<span class="op">$</span>tr,d_seq<span class="op">$</span>site_id, <span class="cf">function</span>(x) <span class="kw">table</span>(x[<span class="dv">1</span><span class="op">:</span>nobs_persite]))</span>
<span id="cb7-88"><a href="sequences.html#cb7-88"></a><span class="kw">sapply</span>(site_tr, <span class="cf">function</span>(x) x)</span></code></pre></div>
<pre><code>##           site1 site2 site3 site4 site5 site6 site7
## Placebo      50    49    51    50    49    49    50
## Treatment    50    51    49    50    51    51    50</code></pre>
<p>Blocking with randomly permuted blocks of size 8 or 12 enforces excellent balance between groups both overall and within strata (in this example, sites).</p>
</div>
<div id="matched-randomization" class="section level2" number="4.5">
<h2><span class="header-section-number">4.5</span> Matched randomization</h2>
<p><em>To be written</em></p>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-Altman1999-zc">
<p>1. Altman DG, Bland MJ. Treatment allocation in controlled trials: Why randomise? BMJ. 1999;318: 1209–1209. </p>
</div>
<div id="ref-Altman1999-da">
<p>2. Altman DG, Bland JM. How to randomise. BMJ. 1999;319: 703–704. </p>
</div>
<div id="ref-Schulz2002-jf">
<p>3. Schulz KF, Grimes DA. Generation of allocation sequences in randomised trials: Chance, not choice. Lancet. 2002;359: 515–519. </p>
</div>
<div id="ref-Lachin1988-gg">
<p>4. Lachin JM. Properties of simple randomization in clinical trials. Control Clin Trials. 1988;9: 312–326. </p>
</div>
<div id="ref-Friedman2015-ri">
<p>5. Friedman LM, Furberg CD, DeMets DL, Reboussin DM, Granger CB. Fundamentals of clinical trials. Springer, Cham; 2015. </p>
</div>
<div id="ref-Schulz2002-xo">
<p>6. Schulz KF, Grimes DA. Unequal group sizes in randomised trials: Guarding against guessing. Lancet. 2002;359: 966–970. </p>
</div>
<div id="ref-Schulz1995-lb">
<p>7. Schulz KF. Subverting randomization in controlled trials. JAMA. 1995;274: 1456–1458. </p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="directory.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="randomizationdiagnostics.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["dcc-randomization.pdf", "dcc-randomization.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
